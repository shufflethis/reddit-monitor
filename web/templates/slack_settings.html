{% extends "base.html" %}

{% block title %}Slack Settings - Reddit Monitor{% endblock %}

{% block content %}
<div class="page-header fade-in-up">
    <h1 class="page-title"><i class="bi bi-slack"></i> Slack Einstellungen</h1>
    <p class="page-subtitle">Konfiguriere Slack-Benachrichtigungen</p>
</div>

<form method="POST" action="/settings/slack">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="grid grid-2 mb-4" style="grid-template-columns: 2fr 1fr;">
        <!-- Bot Token Configuration (Preferred) -->
        <div class="card fade-in-up stagger-1">
            <div class="card-header">
                <i class="bi bi-robot"></i>
                <span>Bot Token (Empfohlen)</span>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Slack Bot Token</label>
                    <input type="password" class="form-control" name="slack_bot_token"
                           value="{{ config.slack_bot_token or '' }}"
                           placeholder="xoxb-...">
                    <div class="form-text">
                        Bot Token aus deiner Slack App. Erlaubt freie Channel-Wahl.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Channel ID</label>
                    <input type="text" class="form-control" name="slack_channel_id"
                           value="{{ config.slack_channel_id or '' }}"
                           placeholder="C0AFT18FN4D">
                    <div class="form-text">
                        Rechtsklick auf Channel &rarr; Channel-Details &rarr; ID kopieren
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">App-Level Token (Socket Mode)</label>
                    <input type="password" class="form-control" name="slack_app_token"
                           value="{{ config.slack_app_token or '' }}"
                           placeholder="xapp-...">
                    <div class="form-text">
                        App-Level Token fuer Socket Mode. Unter App Settings &rarr; Basic Information &rarr; App-Level Tokens generieren (Scope: connections:write).
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Bot Username</label>
                        <input type="text" class="form-control" name="bot_username"
                               value="{{ config.bot_username or 'Reddit Monitor' }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bot Emoji</label>
                        <input type="text" class="form-control" name="bot_emoji"
                               value="{{ config.bot_emoji or ':robot_face:' }}">
                    </div>
                </div>

                <hr style="border-color: var(--border); margin: 1.5rem 0;">
                <details style="color: var(--text-muted);">
                    <summary style="cursor: pointer; margin-bottom: 0.5rem;">Webhook Fallback (optional)</summary>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label class="form-label">Slack Webhook URL</label>
                        <input type="url" class="form-control" name="webhook_url"
                               value="{{ config.slack_webhook or '' }}"
                               placeholder="https://hooks.slack.com/services/...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Channel Name</label>
                        <input type="text" class="form-control" name="slack_channel"
                               value="{{ config.slack_channel or '#general' }}" placeholder="#general">
                    </div>
                </details>
            </div>
        </div>

        <!-- Status & Test -->
        <div class="card fade-in-up stagger-2">
            <div class="card-header">
                <i class="bi bi-activity"></i>
                <span>Status</span>
            </div>
            <div class="card-body">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-muted">Bot Token</span>
                    <span class="badge {% if config.slack_bot_token %}badge-success{% else %}badge-secondary{% endif %}">
                        {% if config.slack_bot_token %}Konfiguriert{% else %}Nicht gesetzt{% endif %}
                    </span>
                </div>
                <div class="flex justify-between items-center mb-3">
                    <span class="text-muted">App Token</span>
                    <span class="badge {% if config.slack_app_token %}badge-success{% else %}badge-secondary{% endif %}">
                        {% if config.slack_app_token %}Socket Mode{% else %}Nicht gesetzt{% endif %}
                    </span>
                </div>
                <div class="flex justify-between items-center mb-3">
                    <span class="text-muted">Channel</span>
                    <span style="color: var(--accent);">{{ config.slack_channel_id or config.slack_channel or '-' }}</span>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-muted">Webhook</span>
                    <span class="badge {% if config.slack_webhook %}badge-success{% else %}badge-secondary{% endif %}">
                        {% if config.slack_webhook %}Fallback{% else %}Nicht gesetzt{% endif %}
                    </span>
                </div>

                <button type="button" id="btn-test-slack" class="btn btn-slack w-full" {% if not config.slack_bot_token and not config.slack_webhook %}disabled{% endif %}>
                    <i class="bi bi-send"></i>
                    Test senden
                </button>
                <div id="test-result" class="mt-2"></div>
            </div>
        </div>
    </div>

    <!-- Notification Types -->
    <div class="card fade-in-up stagger-3 mb-4">
        <div class="card-header">
            <i class="bi bi-bell"></i>
            <span>Benachrichtigungstypen</span>
        </div>
        <div class="card-body">
            <div class="grid grid-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="notify_new_posts" name="notify_new_posts"
                           {% if config.notify_new_posts != False %}checked{% endif %}>
                    <label class="form-check-label" for="notify_new_posts">Neue Posts</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="notify_keywords" name="notify_keywords"
                           {% if config.notify_keywords != False %}checked{% endif %}>
                    <label class="form-check-label" for="notify_keywords">Keyword-Matches</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="notify_errors" name="notify_errors"
                           {% if config.notify_errors %}checked{% endif %}>
                    <label class="form-check-label" for="notify_errors">Fehler & Warnungen</label>
                </div>
            </div>
        </div>
    </div>

    <div class="flex gap-2 fade-in-up stagger-4">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-lg"></i>
            Speichern
        </button>
        <a href="/" class="btn btn-secondary btn-lg">
            <i class="bi bi-arrow-left"></i>
            Zurueck
        </a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('btn-test-slack').addEventListener('click', async function() {
    this.disabled = true;
    this.innerHTML = '<div class="spinner"></div> Sende...';

    try {
        const response = await fetch('/api/slack/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' }
        });
        const data = await response.json();
        document.getElementById('test-result').innerHTML = data.success
            ? '<div class="alert alert-success" style="padding: 0.5rem; margin: 0;">Test erfolgreich!</div>'
            : '<div class="alert alert-danger" style="padding: 0.5rem; margin: 0;">' + data.error + '</div>';
    } catch (error) {
        document.getElementById('test-result').innerHTML = '<div class="alert alert-danger" style="padding: 0.5rem; margin: 0;">' + error.message + '</div>';
    } finally {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-send"></i> Test senden';
    }
});
</script>
{% endblock %}
