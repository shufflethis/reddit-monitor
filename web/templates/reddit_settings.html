{% extends "base.html" %}

{% block title %}Reddit Settings - Reddit Monitor{% endblock %}

{% block content %}
<div class="page-header fade-in-up">
    <h1 class="page-title"><i class="bi bi-reddit"></i> Reddit Einstellungen</h1>
    <p class="page-subtitle">Konfiguriere deinen Reddit-Account und Subreddits</p>
</div>

<form method="POST" action="/settings/reddit">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="grid grid-2 mb-4">
        <!-- Reddit Account -->
        <div class="card fade-in-up stagger-1">
            <div class="card-header">
                <i class="bi bi-person-badge"></i>
                <span>Reddit Account</span>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Reddit Username</label>
                    <input type="text" class="form-control" name="reddit_username"
                           value="{{ config.reddit_username or '' }}" placeholder="DeinUsername">
                    <div class="form-text">Dein Reddit-Benutzername (ohne u/)</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Reddit Password</label>
                    <input type="password" class="form-control" name="reddit_password"
                           placeholder="{% if config.reddit_password %}••••••••{% else %}Passwort eingeben{% endif %}">
                    <div class="form-text">Leer lassen um bestehendes Passwort zu behalten</div>
                </div>

                <hr style="border-color: var(--border); margin: 1.5rem 0;">

                <div class="flex justify-between items-center mb-3">
                    <span class="text-muted">Verbindung</span>
                    <span class="badge {% if config.reddit_username %}badge-success{% else %}badge-secondary{% endif %}">
                        {% if config.reddit_username %}{{ config.reddit_username }}{% else %}Nicht konfiguriert{% endif %}
                    </span>
                </div>

                <button type="button" id="btn-test-reddit" class="btn btn-primary w-full"
                        {% if not config.reddit_username or not config.reddit_password %}disabled{% endif %}>
                    <i class="bi bi-lightning"></i>
                    Login testen
                </button>
                <div id="test-result" class="mt-2"></div>
                <div class="form-text mt-2">
                    Stealth-Browser Login mit AI Captcha-Solver. Beim ersten Mal kann es 15-30 Sekunden dauern.
                </div>
            </div>
        </div>

        <!-- Subreddits -->
        <div class="card fade-in-up stagger-2">
            <div class="card-header">
                <i class="bi bi-collection"></i>
                <span>Subreddits</span>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Zu ueberwachende Subreddits</label>
                    <textarea class="form-control" name="subreddits" rows="6"
                              placeholder="python&#10;programming&#10;learnprogramming">{{ config.subreddits or '' }}</textarea>
                    <div class="form-text">Ein Subreddit pro Zeile (ohne r/)</div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-2 mb-4">
        <!-- Scan Settings -->
        <div class="card fade-in-up stagger-3">
            <div class="card-header">
                <i class="bi bi-clock-history"></i>
                <span>Scan Einstellungen</span>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Scan Interval (Minuten)</label>
                    <input type="number" class="form-control" name="scan_interval"
                           value="{{ config.scan_interval or 15 }}" min="5" max="60">
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Aktiv von</label>
                        <input type="time" class="form-control" name="active_start"
                               value="{{ config.active_start or '09:00' }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Aktiv bis</label>
                        <input type="time" class="form-control" name="active_end"
                               value="{{ config.active_end or '17:00' }}">
                    </div>
                </div>
                <div class="form-text">Zeitraum in dem gescannt wird</div>
            </div>
        </div>

        <!-- Status -->
        <div class="card fade-in-up stagger-4">
            <div class="card-header">
                <i class="bi bi-activity"></i>
                <span>Status</span>
            </div>
            <div class="card-body">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-muted">Subreddits</span>
                    <span class="badge badge-accent">{{ (config.subreddits or '').split('\n')|select|list|length }}</span>
                </div>
                <div class="flex justify-between items-center mb-3">
                    <span class="text-muted">Letzter Scan</span>
                    <span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">
                        {{ config.last_scan[:16] if config.last_scan else 'Noch nie' }}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-muted">Browser-Engine</span>
                    <span style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent);">
                        Patchright + Recognizer AI
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="flex gap-2 fade-in-up stagger-5">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-lg"></i>
            Speichern
        </button>
        <a href="/" class="btn btn-secondary btn-lg">
            <i class="bi bi-arrow-left"></i>
            Zurueck
        </a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('btn-test-reddit').addEventListener('click', async function() {
    this.disabled = true;
    this.textContent = 'Stealth-Login laeuft...';

    const resultDiv = document.getElementById('test-result');

    try {
        const response = await fetch('/api/reddit/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' }
        });
        const data = await response.json();

        resultDiv.textContent = '';
        const alert = document.createElement('div');
        alert.style.padding = '0.5rem';
        alert.style.margin = '0';

        if (data.success) {
            alert.className = 'alert alert-success';
            alert.textContent = data.message;
        } else {
            alert.className = 'alert alert-danger';
            alert.textContent = data.error;
        }
        resultDiv.appendChild(alert);
    } catch (error) {
        resultDiv.textContent = '';
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.style.padding = '0.5rem';
        alert.style.margin = '0';
        alert.textContent = error.message;
        resultDiv.appendChild(alert);
    } finally {
        this.disabled = false;
        this.textContent = '';
        const icon = document.createElement('i');
        icon.className = 'bi bi-lightning';
        this.appendChild(icon);
        this.appendChild(document.createTextNode(' Login testen'));
    }
});
</script>
{% endblock %}
