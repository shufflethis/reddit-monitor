{% extends "base.html" %}

{% block title %}Dashboard - Reddit Monitor{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header fade-in-up">
    <div class="flex justify-between items-center flex-wrap gap-2">
        <div>
            <h1 class="page-title"><i class="bi bi-grid-1x2"></i> Dashboard</h1>
            <p class="page-subtitle">Ueberwache Reddit, erhalte Slack-Benachrichtigungen</p>
        </div>
        <button id="btn-start-stop" class="btn {% if config.monitor_running %}btn-danger{% else %}btn-success{% endif %} btn-lg">
            <i class="bi bi-{% if config.monitor_running %}stop-circle{% else %}play-circle{% endif %}"></i>
            <span>{% if config.monitor_running %}Stoppen{% else %}Starten{% endif %}</span>
        </button>
    </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-4 mb-4">
    <div class="card fade-in-up stagger-1">
        <div class="stat-card">
            <div class="stat-icon" style="background: var(--accent-soft);">
                <i class="bi bi-reddit"></i>
            </div>
            <div class="stat-label">Reddit</div>
            <div class="stat-value {% if config.reddit_username %}success{% else %}danger{% endif %}">
                {% if config.reddit_username %}Online{% else %}Offline{% endif %}
            </div>
            <div class="stat-meta">{{ config.reddit_username or 'Nicht konfiguriert' }}</div>
        </div>
    </div>

    <div class="card fade-in-up stagger-2">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(74, 21, 75, 0.2);">
                <i class="bi bi-slack" style="color: #e01e5a;"></i>
            </div>
            <div class="stat-label">Slack</div>
            <div class="stat-value {% if config.slack_webhook %}success{% else %}danger{% endif %}">
                {% if config.slack_webhook %}Aktiv{% else %}Inaktiv{% endif %}
            </div>
            <div class="stat-meta">{{ config.slack_channel or 'Nicht konfiguriert' }}</div>
        </div>
    </div>

    <div class="card fade-in-up stagger-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: var(--success-glow);">
                <i class="bi bi-collection" style="color: var(--success);"></i>
            </div>
            <div class="stat-label">Subreddits</div>
            <div class="stat-value accent" id="subreddit-count">
                {{ (config.subreddits or '').split('\n')|select|list|length }}
            </div>
            <div class="stat-meta">werden ueberwacht</div>
        </div>
    </div>

    <div class="card fade-in-up stagger-4">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="stat-label">Letzter Scan</div>
            <div class="stat-value" id="last-scan-time" style="font-size: 1rem; color: var(--text-secondary);">
                {% if config.last_scan %}{{ config.last_scan[:16] }}{% else %}Noch nie{% endif %}
            </div>
            <div class="stat-meta">Intervall: {{ config.scan_interval or 15 }} min</div>
        </div>
    </div>
</div>

<!-- Setup Warning -->
{% if not config.reddit_username or not config.slack_webhook %}
<div class="alert alert-warning fade-in-up mb-4">
    <i class="bi bi-exclamation-triangle"></i>
    <div>
        <strong>Setup erforderlich</strong>
        <div class="mt-1" style="font-size: 0.9rem; opacity: 0.9;">
            {% if not config.reddit_username %}
            <a href="/settings/reddit" style="color: inherit; text-decoration: underline;">Reddit-Account konfigurieren</a>
            {% endif %}
            {% if not config.reddit_username and not config.slack_webhook %} | {% endif %}
            {% if not config.slack_webhook %}
            <a href="/settings/slack" style="color: inherit; text-decoration: underline;">Slack-Webhook einrichten</a>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Main Content Grid -->
<div class="grid grid-3 mb-4" style="grid-template-columns: 2fr 1fr;">
    <!-- Actions Card -->
    <div class="card fade-in-up stagger-1">
        <div class="card-header">
            <i class="bi bi-lightning-charge"></i>
            <span>Quick Actions</span>
        </div>
        <div class="card-body">
            <div class="flex flex-wrap gap-2">
                <button id="btn-scan-now" class="btn btn-primary" {% if not config.reddit_username %}disabled{% endif %}>
                    <i class="bi bi-search"></i>
                    <span>Jetzt scannen</span>
                </button>
                <button id="btn-test-slack" class="btn btn-slack" {% if not config.slack_webhook %}disabled{% endif %}>
                    <i class="bi bi-send"></i>
                    <span>Slack testen</span>
                </button>
                <a href="/settings/reddit" class="btn btn-secondary">
                    <i class="bi bi-gear"></i>
                    <span>Reddit</span>
                </a>
                <a href="/settings/guardrails" class="btn btn-secondary">
                    <i class="bi bi-shield-check"></i>
                    <span>Guardrails</span>
                </a>
            </div>

            <!-- Terminal-Style Status -->
            <div class="terminal mt-3">
                <div class="terminal-line">
                    <span class="terminal-prompt">$</span>
                    <span class="terminal-command"> monitor --status</span>
                </div>
                <div class="terminal-line" style="color: var(--text-muted);">
                    <span id="terminal-status">{% if config.monitor_running %}[RUNNING]{% else %}[STOPPED]{% endif %}</span>
                    subreddits={{ (config.subreddits or '').split('\n')|select|list|length }}
                    interval={{ config.scan_interval or 15 }}m
                </div>
            </div>
        </div>
    </div>

    <!-- Status Card -->
    <div class="card fade-in-up stagger-2">
        <div class="card-header">
            <i class="bi bi-activity"></i>
            <span>Monitor Status</span>
        </div>
        <div class="card-body">
            <div class="flex justify-between items-center mb-3">
                <span class="text-muted">Status</span>
                <span id="monitor-status" class="badge {% if config.monitor_running %}badge-success{% else %}badge-secondary{% endif %}">
                    {% if config.monitor_running %}Running{% else %}Stopped{% endif %}
                </span>
            </div>
            <div class="flex justify-between items-center mb-3">
                <span class="text-muted">Aktive Zeit</span>
                <span style="color: var(--text-secondary); font-family: var(--font-mono); font-size: 0.85rem;">
                    {{ config.active_start or '09:00' }} - {{ config.active_end or '17:00' }}
                </span>
            </div>
            <div class="flex justify-between items-center mb-3">
                <span class="text-muted">Min. Upvotes</span>
                <span style="color: var(--accent); font-family: var(--font-mono);">
                    {{ config.min_upvotes or 5 }}
                </span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-muted">Keywords</span>
                <span class="badge badge-accent">
                    {{ (config.keywords or '').split('\n')|select|list|length }}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Posts Section -->
<div class="card fade-in-up stagger-3">
    <div class="card-header flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i class="bi bi-newspaper"></i>
            <span>Gefundene Posts</span>
        </div>
        <span id="posts-count" class="badge badge-secondary">0</span>
    </div>
    <div class="card-body">
        <div id="posts-container">
            <div class="text-center" style="padding: 3rem 1rem;">
                <i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-muted); opacity: 0.5;"></i>
                <p class="mt-2 text-muted">Noch keine Posts gefunden</p>
                <p style="font-size: 0.85rem; color: var(--text-muted);">Klicke auf "Jetzt scannen" um zu starten</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .post-item {
        display: block;
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .post-item:last-child {
        border-bottom: none;
    }

    .post-item:hover {
        background: var(--bg-card-hover);
    }

    .post-title {
        font-family: var(--font-display);
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .post-upvotes {
        color: var(--accent);
        font-family: var(--font-mono);
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .post-content {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        line-height: 1.5;
    }

    .post-meta {
        font-size: 0.8rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .post-subreddit {
        color: var(--accent);
    }

    .post-keywords {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--success);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token() }}';

// Helper to create post element safely
function createPostElement(post) {
    const link = document.createElement('a');
    link.href = post.url;
    link.target = '_blank';
    link.className = 'post-item';

    const titleDiv = document.createElement('div');
    titleDiv.className = 'post-title';
    const titleSpan = document.createElement('span');
    titleSpan.textContent = post.title;
    const upvoteSpan = document.createElement('span');
    upvoteSpan.className = 'post-upvotes';
    upvoteSpan.textContent = '↑ ' + post.upvotes;
    titleDiv.appendChild(titleSpan);
    titleDiv.appendChild(upvoteSpan);

    const contentDiv = document.createElement('div');
    contentDiv.className = 'post-content';
    contentDiv.textContent = (post.content || '').substring(0, 180) + (post.content && post.content.length > 180 ? '...' : '');

    const metaDiv = document.createElement('div');
    metaDiv.className = 'post-meta';
    metaDiv.textContent = 'r/' + post.subreddit + ' • u/' + post.author;

    link.appendChild(titleDiv);
    link.appendChild(contentDiv);
    link.appendChild(metaDiv);

    if (post.matched_keywords && post.matched_keywords.length > 0) {
        const kwDiv = document.createElement('div');
        kwDiv.className = 'post-keywords';
        kwDiv.textContent = '✓ ' + post.matched_keywords.join(', ');
        link.appendChild(kwDiv);
    }

    return link;
}

function showNoPostsMessage(container) {
    container.textContent = '';
    const div = document.createElement('div');
    div.className = 'text-center';
    div.style.padding = '3rem 1rem';
    const icon = document.createElement('div');
    icon.textContent = '✓';
    icon.style.cssText = 'font-size: 3rem; color: var(--success);';
    const msg = document.createElement('p');
    msg.textContent = 'Scan abgeschlossen - keine neuen Posts gefunden';
    msg.style.color = 'var(--text-muted)';
    div.appendChild(icon);
    div.appendChild(msg);
    container.appendChild(div);
}

function setBtnLoading(btn, loading, text) {
    btn.disabled = loading;
    btn.textContent = '';
    if (loading) {
        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        btn.appendChild(spinner);
    }
    const span = document.createElement('span');
    span.textContent = text;
    btn.appendChild(span);
}

// Scan button with polling
document.getElementById('btn-scan-now').addEventListener('click', async function() {
    const btn = this;
    setBtnLoading(btn, true, 'Starte Scan...');

    try {
        console.log('CSRF Token:', csrfToken);
        const response = await fetch('/api/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
        });
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (!data.success && data.error !== 'Scan läuft bereits') {
            alert('Fehler: ' + data.error);
            setBtnLoading(btn, false, 'Jetzt scannen');
            return;
        }

        setBtnLoading(btn, true, 'Scanne...');

        const pollStatus = async () => {
            try {
                const statusRes = await fetch('/api/scan/status', { headers: { 'X-CSRFToken': csrfToken } });
                const statusData = await statusRes.json();

                if (statusData.status === 'running') {
                    setTimeout(pollStatus, 2000);
                    return;
                }

                setBtnLoading(btn, false, 'Jetzt scannen');

                if (statusData.status === 'completed' && statusData.results) {
                    const results = statusData.results;
                    document.getElementById('posts-count').textContent = results.posts_found || 0;
                    document.getElementById('last-scan-time').textContent = new Date().toLocaleString('de-DE');

                    const container = document.getElementById('posts-container');
                    container.textContent = '';

                    if (results.posts && results.posts.length > 0) {
                        results.posts.forEach(post => container.appendChild(createPostElement(post)));
                    } else {
                        showNoPostsMessage(container);
                    }
                } else if (statusData.status === 'error') {
                    alert('Scan Fehler: ' + (statusData.results?.error || 'Unbekannt'));
                }
            } catch (e) {
                console.error('Poll error:', e);
                setTimeout(pollStatus, 3000);
            }
        };

        setTimeout(pollStatus, 2000);

    } catch (error) {
        alert('Fehler: ' + error.message);
        setBtnLoading(btn, false, 'Jetzt scannen');
    }
});

// Test Slack
document.getElementById('btn-test-slack').addEventListener('click', async function() {
    this.disabled = true;
    this.innerHTML = '<div class="spinner"></div><span>Sende...</span>';

    try {
        const response = await fetch('/api/slack/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        const data = await response.json();
        alert(data.success ? 'Test-Nachricht gesendet!' : 'Fehler: ' + data.error);
    } catch (error) {
        alert('Fehler: ' + error.message);
    } finally {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-send"></i><span>Slack testen</span>';
    }
});

// Start/Stop Monitor
document.getElementById('btn-start-stop').addEventListener('click', async function() {
    const isRunning = this.classList.contains('btn-danger');
    const endpoint = isRunning ? '/api/monitor/stop' : '/api/monitor/start';

    this.disabled = true;
    this.innerHTML = '<div class="spinner"></div><span>...</span>';

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
        });

        const data = await response.json();

        if (data.success) {
            if (data.status === 'running') {
                this.className = 'btn btn-danger btn-lg';
                this.innerHTML = '<i class="bi bi-stop-circle"></i><span>Stoppen</span>';
                document.getElementById('monitor-status').className = 'badge badge-success';
                document.getElementById('monitor-status').textContent = 'Running';
                document.getElementById('terminal-status').textContent = '[RUNNING]';
            } else {
                this.className = 'btn btn-success btn-lg';
                this.innerHTML = '<i class="bi bi-play-circle"></i><span>Starten</span>';
                document.getElementById('monitor-status').className = 'badge badge-secondary';
                document.getElementById('monitor-status').textContent = 'Stopped';
                document.getElementById('terminal-status').textContent = '[STOPPED]';
            }
        }
    } catch (error) {
        alert('Fehler: ' + error.message);
    } finally {
        this.disabled = false;
    }
});
</script>
{% endblock %}
