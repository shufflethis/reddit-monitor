{% extends "base.html" %}

{% block title %}Dashboard - Reddit Monitor{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
                <p class="text-muted mb-0">Monitor Reddit, get Slack notifications</p>
            </div>
            <div>
                <button id="btn-start-stop" class="btn btn-lg {% if config.monitor_running %}btn-danger{% else %}btn-success{% endif %}">
                    <i class="bi bi-{% if config.monitor_running %}stop-circle{% else %}play-circle{% endif %}"></i>
                    {% if config.monitor_running %}Monitor stoppen{% else %}Monitor starten{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status Cards -->
<div class="row">
    <div class="col-md-3 col-sm-6">
        <div class="card mb-4">
            <div class="card-body stat-card">
                <h6 class="text-muted"><i class="bi bi-reddit"></i> Reddit</h6>
                <div class="stat-number" id="reddit-status">
                    {% if config.reddit_username %}
                    <span class="status-active">Aktiv</span>
                    {% else %}
                    <span class="status-inactive">Inaktiv</span>
                    {% endif %}
                </div>
                <small class="text-muted">{{ config.reddit_username or 'Nicht konfiguriert' }}</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card mb-4">
            <div class="card-body stat-card">
                <h6 class="text-muted"><i class="bi bi-slack"></i> Slack</h6>
                <div class="stat-number" id="slack-status">
                    {% if config.slack_webhook %}
                    <span class="status-active">Aktiv</span>
                    {% else %}
                    <span class="status-inactive">Inaktiv</span>
                    {% endif %}
                </div>
                <small class="text-muted">{{ config.slack_channel or 'Nicht konfiguriert' }}</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card mb-4">
            <div class="card-body stat-card">
                <h6 class="text-muted"><i class="bi bi-collection"></i> Subreddits</h6>
                <div class="stat-number" id="subreddit-count">
                    {{ (config.subreddits or '').split('\n')|select|list|length }}
                </div>
                <small class="text-muted">konfiguriert</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card mb-4">
            <div class="card-body stat-card">
                <h6 class="text-muted"><i class="bi bi-clock-history"></i> Letzter Scan</h6>
                <div id="last-scan-time" style="font-size: 1.2rem; color: var(--reddit-orange);">
                    {% if config.last_scan %}
                    {{ config.last_scan[:16] }}
                    {% else %}
                    Noch nie
                    {% endif %}
                </div>
                <small class="text-muted">Interval: {{ config.scan_interval or 15 }} min</small>
            </div>
        </div>
    </div>
</div>

<!-- Quick Setup -->
{% if not config.reddit_username or not config.slack_webhook %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle"></i> Setup erforderlich</h5>
            <p class="mb-2">Folgende Einstellungen fehlen noch:</p>
            <ul class="mb-0">
                {% if not config.reddit_username %}
                <li><a href="/settings/reddit" class="alert-link">Reddit-Account konfigurieren</a></li>
                {% endif %}
                {% if not config.slack_webhook %}
                <li><a href="/settings/slack" class="alert-link">Slack-Webhook einrichten</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
{% endif %}

<!-- Actions -->
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-lightning"></i> Aktionen
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button id="btn-scan-now" class="btn btn-primary" {% if not config.reddit_username %}disabled{% endif %}>
                        <i class="bi bi-search"></i> Jetzt scannen
                    </button>
                    <button id="btn-test-slack" class="btn btn-slack" {% if not config.slack_webhook %}disabled{% endif %}>
                        <i class="bi bi-send"></i> Slack testen
                    </button>
                    <a href="/settings/reddit" class="btn btn-outline-light">
                        <i class="bi bi-gear"></i> Reddit Settings
                    </a>
                    <a href="/settings/guardrails" class="btn btn-outline-light">
                        <i class="bi bi-shield"></i> Guardrails
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-clock"></i> Monitor Status
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Status:</span>
                    <span id="monitor-status" class="badge {% if config.monitor_running %}bg-success{% else %}bg-secondary{% endif %}">
                        {% if config.monitor_running %}Laeuft{% else %}Gestoppt{% endif %}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Aktiv:</span>
                    <span class="text-info">{{ config.active_start or '09:00' }} - {{ config.active_end or '17:00' }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Naechster Scan:</span>
                    <span id="next-scan" class="text-muted">-</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Posts -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-newspaper"></i> Gefundene Posts</span>
                <span id="posts-count" class="badge bg-secondary">0</span>
            </div>
            <div class="card-body">
                <div id="posts-container">
                    <p class="text-muted text-center py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
                        Noch keine Posts gefunden. Klicke auf "Jetzt scannen" um zu starten.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token() }}';

// Scan button
document.getElementById('btn-scan-now').addEventListener('click', async function() {
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Scanne...';

    try {
        const response = await fetch('/api/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            document.getElementById('posts-count').textContent = data.posts_found;
            document.getElementById('last-scan-time').textContent = new Date().toLocaleString('de-DE');

            if (data.posts && data.posts.length > 0) {
                let html = '<div class="list-group list-group-flush">';
                data.posts.forEach(post => {
                    html += `
                    <a href="${post.url}" target="_blank" class="list-group-item list-group-item-action bg-transparent text-white border-0 border-bottom" style="border-color: rgba(255,255,255,0.1) !important;">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${post.title}</h6>
                            <small class="text-warning">${post.upvotes} <i class="bi bi-arrow-up"></i></small>
                        </div>
                        <p class="mb-1 text-muted small">${post.content.substring(0, 150)}...</p>
                        <small class="text-info">r/${post.subreddit} &bull; u/${post.author}</small>
                        ${post.matched_keywords && post.matched_keywords.length > 0 ?
                          `<br><small class="text-success"><i class="bi bi-check-circle"></i> Keywords: ${post.matched_keywords.join(', ')}</small>` : ''}
                    </a>
                    `;
                });
                html += '</div>';
                document.getElementById('posts-container').innerHTML = html;
            } else {
                document.getElementById('posts-container').innerHTML = `
                    <p class="text-muted text-center py-4">
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i><br>
                        Scan abgeschlossen. Keine neuen Posts gefunden, die den Guardrails entsprechen.
                    </p>
                `;
            }
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (error) {
        alert('Fehler: ' + error.message);
    } finally {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-search"></i> Jetzt scannen';
    }
});

// Test Slack button
document.getElementById('btn-test-slack').addEventListener('click', async function() {
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sende...';

    try {
        const response = await fetch('/api/slack/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('Test-Nachricht erfolgreich gesendet!');
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (error) {
        alert('Fehler: ' + error.message);
    } finally {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-send"></i> Slack testen';
    }
});

// Start/Stop Monitor button
document.getElementById('btn-start-stop').addEventListener('click', async function() {
    const isRunning = this.classList.contains('btn-danger');
    const endpoint = isRunning ? '/api/monitor/stop' : '/api/monitor/start';

    this.disabled = true;

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            if (data.status === 'running') {
                this.className = 'btn btn-lg btn-danger';
                this.innerHTML = '<i class="bi bi-stop-circle"></i> Monitor stoppen';
                document.getElementById('monitor-status').className = 'badge bg-success';
                document.getElementById('monitor-status').textContent = 'Laeuft';
            } else {
                this.className = 'btn btn-lg btn-success';
                this.innerHTML = '<i class="bi bi-play-circle"></i> Monitor starten';
                document.getElementById('monitor-status').className = 'badge bg-secondary';
                document.getElementById('monitor-status').textContent = 'Gestoppt';
            }
        }
    } catch (error) {
        alert('Fehler: ' + error.message);
    } finally {
        this.disabled = false;
    }
});

// Load status on page load
async function loadStatus() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        // Update UI with status
    } catch (error) {
        console.error('Error loading status:', error);
    }
}

document.addEventListener('DOMContentLoaded', loadStatus);
</script>
{% endblock %}
